{% comment %}
 How to Use 

 Paste 
 {% section 'support-widget' %} below the opening of the body tag in the theme.liquid file 
{% endcomment %}

{{ 'support-widget.css' | asset_url | stylesheet_tag }}

<div id="support-widget" class="support-widget-position-bottom_left support-widget-dashboard--active" style="--support-widget-color: {{ section.settings.text_color }}; --support-widget-background: {{ section.settings.bg_color }}; --support-widget-background-dark: {{ section.settings.bg_color }}; --support-widget-background-light: {{ section.settings.bg_color }}; --support-widget-box-shadow: rgba(0,0,0,0.06) 0 1px 6px 0, rgba(0,0,0,0.16) 0 2px 32px 0; --support-widget-social-color: {{ section.settings.bg_color }}; --support-widget-social-background: {{ section.settings.text_color }}; --support-widget-position-bottom: 20px; --support-widget-position-left: 20px; --support-widget-position-right: 20px;">
  
  <div class="support-widget-button">
    {% if section.settings.trigger_icon_svg != blank %}
      {{ section.settings.trigger_icon_svg }}
    {% else %}
      <svg class="support-widget-svg" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path d="M136,210c-24.814,0-45,20.186-45,45v122c0,24.814,20.186,45,45,45c24.814,0,45-20.186,45-45V255 C181,230.186,160.814,210,136,210z"></path><path d="M61,255c0-4.327,0.571-8.507,1.278-12.634C44.2,248.209,31,265.001,31,285v62c0,19.999,13.2,36.791,31.278,42.634 C61.571,385.507,61,381.327,61,377V255z"></path><path d="M376,210c-24.814,0-45,20.186-45,45v122c0,24.814,20.186,45,45,45c4.51,0,8.782-0.868,12.892-2.108 C383.308,438.401,366.305,452,346,452h-47.763c-6.213-17.422-22.707-30-42.237-30c-24.814,0-45,20.186-45,45 c0,24.814,20.186,45,45,45c19.53,0,36.024-12.578,42.237-30H346c41.353,0,75-33.647,75-75v-30V255 C421,230.186,400.814,210,376,210z"></path><path d="M449.722,242.366C450.429,246.493,451,250.673,451,255v122c0,4.327-0.571,8.507-1.278,12.634 C467.8,383.791,481,366.999,481,347v-62C481,265.001,467.8,248.209,449.722,242.366z"></path><path d="M256,0C131.928,0,31,100.928,31,225v0.383c8.937-6.766,19.277-11.717,30.687-13.934C68.698,110.251,153.054,30,256,30 s187.302,80.251,194.313,181.448c11.409,2.217,21.749,7.169,30.687,13.934V225C481,100.928,380.072,0,256,0z"></path></svg>
    {% endif %}
  </div>

  <div id="support-widget-box">
    <div class="support-widget-box-container">
      
      <div class="support-widget-header">
        <div class="support-widget-search support-widget-tooltip" style="display: none;" data-tooltip="Search">
        </div>
        <div class="support-widget-channels">
          {% if section.settings.contact_phone != blank %}
          <div class="support-widget-channel support-widget-tooltip" data-tooltip="Continue on Phone">
            <a href="tel:{{ section.settings.contact_phone }}" style="color: inherit; display: flex;">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path d="M493.4 24.6l-104-24c-11.3-2.6-22.9 3.3-27.5 13.9l-48 112c-4.2 9.8-1.4 21.3 6.9 28l60.6 49.6c-36 76.7-98.9 140.5-177.2 177.2l-49.6-60.6c-6.8-8.3-18.2-11.1-28-6.9l-112 48C3.9 366.5-2 378.1.6 389.4l24 104C27.1 504.2 36.7 512 48 512c256.1 0 464-207.5 464-464 0-11.2-7.7-20.9-18.6-23.4z"></path></svg>
            </a>
          </div>
          {% endif %}
          {% if section.settings.contact_whatsapp != blank %}
          <div class="support-widget-channel support-widget-tooltip" data-tooltip="Continue on WhatsApp">
             <a href="{{ section.settings.contact_whatsapp }}" target="_blank" style="color: inherit; display: flex;">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="m17.507 14.307-.009.075c-2.199-1.096-2.429-1.242-2.713-.816-.197.295-.771.964-.944 1.162-.175.195-.349.21-.646.075-.3-.15-1.263-.465-2.403-1.485-.888-.795-1.484-1.77-1.66-2.07-.293-.506.32-.578.878-1.634.1-.21.049-.375-.025-.524-.075-.15-.672-1.62-.922-2.206-.24-.584-.487-.51-.672-.51-.576-.05-.997-.042-1.368.344-1.614 1.774-1.207 3.604.174 5.55 2.714 3.552 4.16 4.206 6.804 5.114.714.227 1.365.195 1.88.121.574-.091 1.767-.721 2.016-1.426.255-.705.255-1.29.18-1.425-.074-.135-.27-.21-.57-.345z"></path><path d="m20.52 3.449c-7.689-7.433-20.414-2.042-20.419 8.444 0 2.096.549 4.14 1.595 5.945l-1.696 6.162 6.335-1.652c7.905 4.27 17.661-1.4 17.665-10.449 0-3.176-1.24-6.165-3.495-8.411zm1.482 8.417c-.006 7.633-8.385 12.4-15.012 8.504l-.36-.214-3.75.975 1.005-3.645-.239-.375c-4.124-6.565.614-15.145 8.426-15.145 2.654 0 5.145 1.035 7.021 2.91 1.875 1.859 2.909 4.35 2.909 6.99z"></path></svg>
            </a>
          </div>
          {% endif %}
          {% if section.settings.contact_email != blank %}
          <div class="support-widget-channel support-widget-tooltip" data-tooltip="Continue on Email">
             <a href="mailto:{{ section.settings.contact_email }}" style="color: inherit; display: flex;">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path d="M467,61H45c-6.927,0-13.412,1.703-19.279,4.51L255,294.789l51.389-49.387c0,0,0.004-0.005,0.005-0.007 c0.001-0.002,0.005-0.004,0.005-0.004L486.286,65.514C480.418,62.705,473.929,61,467,61z"></path><path d="M507.496,86.728L338.213,256.002L507.49,425.279c2.807-5.867,4.51-12.352,4.51-19.279V106 C512,99.077,510.301,92.593,507.496,86.728z"></path><path d="M4.51,86.721C1.703,92.588,0,99.073,0,106v300c0,6.923,1.701,13.409,4.506,19.274L173.789,256L4.51,86.721z"></path><path d="M317.002,277.213l-51.396,49.393c-2.93,2.93-6.768,4.395-10.605,4.395s-7.676-1.465-10.605-4.395L195,277.211 L25.714,446.486C31.582,449.295,38.071,451,45,451h422c6.927,0,13.412-1.703,19.279-4.51L317.002,277.213z"></path></svg>
            </a>
          </div>
          {% endif %}
        </div>
        <div class="support-widget-close">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"><path d="M11.414 10l6.293-6.293a1 1 0 10-1.414-1.414L10 8.586 3.707 2.293a1 1 0 00-1.414 1.414L8.586 10l-6.293 6.293a1 1 0 101.414 1.414L10 11.414l6.293 6.293A.998.998 0 0018 17a.999.999 0 00-.293-.707L11.414 10z"></path></svg>
        </div>
      </div>
      
      <div class="support-widget-body">

        <div id="support-widget-dashboard" class="support-widget-panel">
          <div class="support-widget-container">
            <div class="support-widget-categories">
              <div class="support-widget-heading">FAQ Categories</div>
              <div class="support-widget-row" id="support-widget-category-grid">
              </div>
            </div>
            
            <div class="support-widget-featured">
              <br>
              <div class="support-widget-heading">General Queries</div>
              <div class="support-widget-row" id="support-widget-featured-list">
              </div>
            </div>
          </div>
        </div>

        <div id="support-widget-category" class="support-widget-panel">
          <div class="support-widget-container">
            <div class="support-widget-page-header">
              <div class="support-widget-page-breadcrumb">
                <div class="support-widget-breadcrumb" data-back="dashboard">
                  <span class="support-widget-icon"><svg viewBox="0 0 20 20" class="support-widget-icon__svg"><path d="M17 9H5.414l3.293-3.293a.999.999 0 1 0-1.414-1.414l-5 5a.999.999 0 0 0 0 1.414l5 5a.997.997 0 0 0 1.414 0 .999.999 0 0 0 0-1.414L5.414 11H17a1 1 0 1 0 0-2z"></path></svg></span>
                </div>
              </div>
              <div class="support-widget-page-title">
                <div class="support-widget-title" id="support-widget-category-title"></div>
              </div>
            </div>
            <div class="support-widget-row" id="support-widget-category-list">
            </div>
          </div>
        </div>

        <div id="support-widget-article" class="support-widget-panel">
          <div class="support-widget-container">
            <div class="support-widget-page-header">
              <div class="support-widget-page-breadcrumb">
                <div class="support-widget-breadcrumb" data-back="category">
                  <span class="support-widget-icon"><svg viewBox="0 0 20 20" class="support-widget-icon__svg"><path d="M17 9H5.414l3.293-3.293a.999.999 0 1 0-1.414-1.414l-5 5a.999.999 0 0 0 0 1.414l5 5a.997.997 0 0 0 1.414 0 .999.999 0 0 0 0-1.414L5.414 11H17a1 1 0 1 0 0-2z"></path></svg></span>
                </div>
              </div>
              <div class="support-widget-page-title">
                <div class="support-widget-title" id="support-widget-article-title"></div>
                <div class="support-widget-subtitle" id="support-widget-article-subtitle" data-back="category"></div>
              </div>
            </div>
            <div class="support-widget-answer" id="support-widget-article-answer">
            </div>
            <div class="support-widget-page-footer">
              <div class="support-widget-pagination">
                <div class="support-widget-navitem" id="support-widget-nav-prev">
                </div>
                <div class="support-widget-navitem" id="support-widget-nav-next">
                </div>
              </div>
            </div>
          </div>
        </div>

      </div>
    </div>
    <div class="support-widget-branding" style="display: flex !important;">
    </div>
  </div>
</div>

<script id="support-widget-data" type="application/json">
{% if shop.metafields.custom.faq_data != blank %}
  {% assign faq_data = shop.metafields.custom.faq_data.value %}
  {
    "categories": [
      {% for category in faq_data.categories %}
      {
        "id": {{ category.id }},
        "title": {{ category.title | json }},
        "icon": {{ category.icon | json }}
      }{% unless forloop.last %},{% endunless %}
      {% endfor %}
    ],
    "questions": [
      {% for question in faq_data.questions %}
      {
        "id": {{ question.id }},
        "category_id": {{ question.category_id }},
        "question": {{ question.question | json }},
        "answer": {{ question.answer | json }},
        "featured": {{ question.featured }}
      }{% unless forloop.last %},{% endunless %}
      {% endfor %}
    ]
  }
{% else %}
  null
{% endif %}
</script>

<script>
(function() {
  'use strict';
  
  var dataElement = document.getElementById('support-widget-data');
  var supportWidgetData = null;
  
  if (dataElement && dataElement.textContent) {
    try {
      var content = dataElement.textContent.trim();
      console.log('Raw data content:', content.substring(0, 200));
      supportWidgetData = JSON.parse(content);
      console.log('Support Widget: Data loaded successfully', supportWidgetData);
    } catch (e) {
      console.error('Support Widget: Error parsing data', e);
      console.log('Content that failed:', dataElement.textContent);
    }
  } else {
    console.error('Support Widget: Data element not found');
  }
  
  function escapeHtml(text) {
    if (!text) return '';
    var div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  }
  
  function initSupportWidget() {
    console.log('Support Widget: Initializing...');
    
    var widget = document.getElementById('support-widget');
    if (!widget) {
      console.error('Support Widget: Widget element not found');
      return;
    }

    if (!supportWidgetData || !supportWidgetData.categories || !supportWidgetData.questions) {
      console.error('Support Widget: Invalid data format');
      console.log('Data received:', supportWidgetData);
      return;
    }

    console.log('Found', supportWidgetData.categories.length, 'categories and', supportWidgetData.questions.length, 'questions');

    // --- DOM Elements ---
    var trigger = widget.querySelector('.support-widget-button');
    var closeBtn = widget.querySelector('.support-widget-close');
    var panelContainer = widget.querySelector('.support-widget-body');

    // Panel elements
    var categoryGrid = document.getElementById('support-widget-category-grid');
    var featuredList = document.getElementById('support-widget-featured-list');
    var categoryTitle = document.getElementById('support-widget-category-title');
    var categoryList = document.getElementById('support-widget-category-list');
    var articleTitle = document.getElementById('support-widget-article-title');
    var articleSubtitle = document.getElementById('support-widget-article-subtitle');
    var articleAnswer = document.getElementById('support-widget-article-answer');
    var navPrev = document.getElementById('support-widget-nav-prev');
    var navNext = document.getElementById('support-widget-nav-next');

    // --- State ---
    var currentCategoryId = null;
    var currentArticleId = null;
    var data = supportWidgetData;

    // --- Helper Functions ---
    
    function findCategory(id) {
      for (var i = 0; i < data.categories.length; i++) {
        if (data.categories[i].id == id) {
          return data.categories[i];
        }
      }
      return null;
    }

    function findArticle(id) {
      for (var i = 0; i < data.questions.length; i++) {
        if (data.questions[i].id == id) {
          return data.questions[i];
        }
      }
      return null;
    }
    
    function getArticlesForCategory(categoryId) {
      var articles = [];
      for (var i = 0; i < data.questions.length; i++) {
        if (data.questions[i].category_id == categoryId) {
          articles.push(data.questions[i]);
        }
      }
      return articles;
    }

    function openWidget() {
      console.log('Opening widget');
      widget.classList.add('support-widget--open');
    }
    
    function closeWidget() {
      console.log('Closing widget');
      widget.classList.remove('support-widget--open');
      setTimeout(function() {
        showPanel('dashboard');
        currentCategoryId = null;
        currentArticleId = null;
      }, 300);
    }

    function showPanel(panelName) {
      console.log('Showing panel:', panelName);
      widget.classList.remove(
        'support-widget-dashboard--active', 
        'support-widget-category--active', 
        'support-widget-article--active'
      );
      widget.classList.add('support-widget-' + panelName + '--active');
      if (panelContainer) {
        panelContainer.scrollTop = 0;
      }
    }

    // --- Build Functions ---

    function buildDashboardPanel() {
      console.log('Building dashboard...');
      
      if (!categoryGrid || !featuredList) {
        console.error('Grid elements not found');
        return;
      }
      
      // Clear existing content
      categoryGrid.innerHTML = '';
      featuredList.innerHTML = '';

      // Build Categories
      console.log('Building categories:', data.categories.length);
      for (var i = 0; i < data.categories.length; i++) {
        var cat = data.categories[i];
        var categoryCard = document.createElement('div');
        categoryCard.className = 'support-widget-column--half';
        categoryCard.innerHTML = 
          '<div class="support-widget-card" data-type="category" data-id="' + cat.id + '">' +
            '<span class="support-widget-avatar support-widget-avatar--hasImage">' +
              (cat.icon ? '<img src="' + cat.icon + '" alt="' + escapeHtml(cat.title) + '" class="support-widget-avatar__image">' : '') +
            '</span>' +
            '<div class="support-widget-text support-widget-text--variationSubdued">' + escapeHtml(cat.title) + '</div>' +
          '</div>';
        categoryGrid.appendChild(categoryCard);
      }
      console.log('Categories built successfully');

      // Build Featured Questions
      var featuredCount = 0;
      for (var i = 0; i < data.questions.length; i++) {
        var q = data.questions[i];
        if (q.featured === true) {
          var cat = findCategory(q.category_id);
          if (!cat) continue;
          
          var featuredCard = document.createElement('div');
          featuredCard.className = 'support-widget-column';
          featuredCard.innerHTML = 
            '<div class="support-widget-card" data-type="article" data-id="' + q.id + '" data-parent="' + cat.id + '">' +
              '<span class="support-widget-avatar support-widget-avatar--hasImage">' +
                (cat.icon ? '<img src="' + cat.icon + '" alt="' + escapeHtml(cat.title) + '" class="support-widget-avatar__image">' : '') +
              '</span>' +
              '<div class="support-widget-text">' +
                '<div class="support-widget-text--variationStrong">' + escapeHtml(q.question) + '</div>' +
                '<div class="support-widget-text--caption">' + escapeHtml(cat.title) + '</div>' +
              '</div>' +
            '</div>';
          featuredList.appendChild(featuredCard);
          featuredCount++;
        }
      }
      console.log('Featured questions built:', featuredCount);
    }

    function buildCategoryPanel(categoryId) {
      console.log('Building category:', categoryId);
      var cat = findCategory(categoryId);
      if (!cat) {
        console.error('Category not found:', categoryId);
        return;
      }
      
      currentCategoryId = categoryId;
      
      if (categoryTitle) {
        categoryTitle.textContent = cat.title;
      }
      
      if (categoryList) {
        categoryList.innerHTML = '';
        var articles = getArticlesForCategory(categoryId);
        console.log('Articles in category:', articles.length);
        
        for (var i = 0; i < articles.length; i++) {
          var article = articles[i];
          var articleCard = document.createElement('div');
          articleCard.className = 'support-widget-column';
          articleCard.innerHTML = 
            '<div class="support-widget-card" data-type="article" data-id="' + article.id + '" data-parent="' + categoryId + '">' +
              '<span class="support-widget-avatar support-widget-avatar--hasImage">' +
                (cat.icon ? '<img src="' + cat.icon + '" alt="' + escapeHtml(cat.title) + '" class="support-widget-avatar__image">' : '') +
              '</span>' +
              '<div class="support-widget-text">' +
                '<div class="support-widget-text--variationStrong">' + escapeHtml(article.question) + '</div>' +
                '<div class="support-widget-text--caption">' + escapeHtml(cat.title) + '</div>' +
              '</div>' +
            '</div>';
          categoryList.appendChild(articleCard);
        }
      }
      
      showPanel('category');
    }
    
    function buildArticlePanel(articleId) {
      console.log('Building article:', articleId);
      var article = findArticle(articleId);
      if (!article) {
        console.error('Article not found:', articleId);
        return;
      }
      
      var cat = findCategory(article.category_id);
      if (!cat) {
        console.error('Category not found for article');
        return;
      }
      
      currentArticleId = articleId;
      currentCategoryId = cat.id;

      if (articleTitle) {
        articleTitle.textContent = article.question;
      }
      if (articleSubtitle) {
        articleSubtitle.textContent = cat.title;
      }
      if (articleAnswer) {
        articleAnswer.innerHTML = article.answer;
      }
      
      // Navigation
      var articles = getArticlesForCategory(cat.id);
      var currentIndex = -1;
      for (var i = 0; i < articles.length; i++) {
        if (articles[i].id == articleId) {
          currentIndex = i;
          break;
        }
      }
      
      if (navPrev) {
        navPrev.innerHTML = '';
        if (currentIndex > 0) {
          var prev = articles[currentIndex - 1];
          navPrev.innerHTML = 
            '<div class="support-widget-navlink support-widget-navlink--previous" data-type="article" data-id="' + prev.id + '">' +
              '<span class="support-widget-icon"><svg viewBox="0 0 20 20" class="support-widget-icon__svg"><path d="M17 9H5.414l3.293-3.293a.999.999 0 1 0-1.414-1.414l-5 5a.999.999 0 0 0 0 1.414l5 5a.997.997 0 0 0 1.414 0 .999.999 0 0 0 0-1.414L5.414 11H17a1 1 0 1 0 0-2z"></path></svg></span>' +
              '<div class="support-widget-subheading">' + escapeHtml(prev.question) + '</div>' +
            '</div>';
        }
      }
      
      if (navNext) {
        navNext.innerHTML = '';
        if (currentIndex < articles.length - 1) {
          var next = articles[currentIndex + 1];
          navNext.innerHTML = 
            '<div class="support-widget-navlink support-widget-navlink--next" data-type="article" data-id="' + next.id + '">' +
              '<div class="support-widget-subheading">' + escapeHtml(next.question) + '</div>' +
              '<span class="support-widget-icon"><svg viewBox="0 0 20 20" class="support-widget-icon__svg"><path d="M17.707 9.293l-5-5a.999.999 0 10-1.414 1.414L14.586 9H3a1 1 0 100 2h11.586l-3.293 3.293a.999.999 0 101.414 1.414l5-5a.999.999 0 000-1.414z"></path></svg></span>' +
            '</div>';
        }
      }
      
      showPanel('article');
    }

    // --- Event Handlers ---

    function handleClick(e) {
      var target = e.target;
      
      // Find closest clickable element
      var card = target.closest('.support-widget-card');
      if (card && card.dataset.id) {
        e.preventDefault();
        e.stopPropagation();
        var type = card.dataset.type;
        var id = parseInt(card.dataset.id);
        console.log('Card clicked - Type:', type, 'ID:', id);
        
        if (type === 'category') {
          buildCategoryPanel(id);
        } else if (type === 'article') {
          buildArticlePanel(id);
        }
        return;
      }
      
      var breadcrumb = target.closest('.support-widget-breadcrumb');
      if (breadcrumb && breadcrumb.dataset.back) {
        e.preventDefault();
        e.stopPropagation();
        var back = breadcrumb.dataset.back;
        console.log('Breadcrumb clicked - Back to:', back);
        if (back === 'dashboard') {
          showPanel('dashboard');
        } else if (back === 'category' && currentCategoryId) {
          buildCategoryPanel(currentCategoryId);
        }
        return;
      }
      
      var subtitle = target.closest('.support-widget-subtitle');
      if (subtitle && subtitle.dataset.back && currentCategoryId) {
        e.preventDefault();
        e.stopPropagation();
        console.log('Subtitle clicked - Back to category');
        buildCategoryPanel(currentCategoryId);
        return;
      }
      
      var navLink = target.closest('.support-widget-navlink');
      if (navLink && navLink.dataset.id) {
        e.preventDefault();
        e.stopPropagation();
        var id = parseInt(navLink.dataset.id);
        console.log('Nav link clicked - Article ID:', id);
        buildArticlePanel(id);
        return;
      }
    }

    // --- Initialize ---
    
    buildDashboardPanel();

    // Event listeners
    if (trigger) {
      trigger.addEventListener('click', function(e) {
        e.preventDefault();
        e.stopPropagation();
        openWidget();
      });
      console.log('Trigger button listener attached');
    } else {
      console.error('Trigger button not found');
    }
    
    if (closeBtn) {
      closeBtn.addEventListener('click', function(e) {
        e.preventDefault();
        e.stopPropagation();
        closeWidget();
      });
      console.log('Close button listener attached');
    } else {
      console.error('Close button not found');
    }
    
    widget.addEventListener('click', handleClick);
    
    console.log('Support Widget: Fully initialized and ready!');
  }
  
  // Run when DOM is ready
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initSupportWidget);
  } else {
    initSupportWidget();
  }
})();
</script>


{% schema %}
{
  "name": "Support Drawer",
  "tag": "section",
  "settings": [
    {
      "type": "color",
      "id": "bg_color",
      "label": "Header Background",
      "default": "#b82928"
    },
    {
      "type": "color",
      "id": "text_color",
      "label": "Header Text & Icons",
      "default": "#ffffff"
    },
    {
      "type": "header",
      "content": "Trigger Button"
    },
    {
      "type": "html",
      "id": "trigger_icon_svg",
      "label": "Trigger Icon SVG",
      "info": "Paste an SVG snippet here. Leave blank for default."
    },
    {
      "type": "header",
      "content": "Contact Links"
    },
    {
      "type": "text",
      "id": "contact_phone",
      "label": "Phone Number",
      "info": "e.g., '+123456789'"
    },
    {
      "type": "url",
      "id": "contact_whatsapp",
      "label": "WhatsApp Link",
      "info": "e.g., 'https://wa.me/123456789'"
    },
    {
      "type": "text",
      "id": "contact_email",
      "label": "Email Address",
      "info": "e.g., 'support@example.com'"
    }
  ],
  "presets": [
    {
      "name": "Support Drawer"
    }
  ]
}
{% endschema %}
